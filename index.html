<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Mobile Arcade</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#050912">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png"><!-- اختياري، أو خلّها لاحقاً -->

  <style>
    html,body{ margin:0; height:100%; background:#000; overscroll-behavior:none; }
    body{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; touch-action:none; font:600 14px system-ui, -apple-system, Segoe UI, Roboto; color:#e9eef7; }
    .app{ position:fixed; inset:0; background:#050912; }
    .center{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .landing{ gap:18px; flex-direction:column; text-align:center; padding:20px; }
    .title{ font:700 22px system-ui; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .btn{ appearance:none; border:0; padding:12px 16px; border-radius:12px; background:#0b1b2e; color:#e9eef7; cursor:pointer; font:700 16px system-ui; }
    .small{ font-size:12px; opacity:.75; }
    .topbar{
      position:absolute; top:0; left:0; right:0; height:52px; display:none;
      align-items:center; justify-content:space-between; gap:8px; padding:0 10px;
      background:rgba(5,9,18,.6); backdrop-filter:blur(6px); border-bottom:1px solid #152033; z-index:5;
    }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding:8px 12px; border-radius:10px; background:#0b1220; border:1px solid #1b2b44; cursor:pointer; opacity:.95 }
    .tab.active{ background:#1a2a49 }
    .xbtn{ appearance:none; border:0; background:#c0392b; color:#fff; font:700 16px system-ui; width:36px; height:36px; border-radius:9px; cursor:pointer; }
    .hud{ position:absolute; top:56px; left:0; right:0; display:none; gap:6px; justify-content:center; flex-wrap:wrap; z-index:4 }
    .pill{ background:#0b1220; border:1px solid #1b2b44; border-radius:999px; padding:6px 10px; }
    .badges{ position:absolute; top:96px; left:0; right:0; display:none; gap:6px; justify-content:center; flex-wrap:wrap; z-index:4 }
    canvas{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#000; border:1px solid #1b2b44; border-radius:12px; touch-action:none; display:none;
    }
    .hint{ position:absolute; bottom:14px; left:0; right:0; text-align:center; font-weight:600; opacity:.7 }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- شاشة البداية -->
    <div class="center landing" id="landing">
      <div class="title">🎮 Mobile Arcade</div>
      <div class="row">
        <button class="btn" id="startSpace">🚀 Space Blaster</button>
        <button class="btn" id="startAR">🎯 AR-Lite Throw</button>
      </div>
      <div class="small">تعمل فل-سكرين عند الإضافة إلى الشاشة الرئيسية.</div>
      <div class="small">للخروج من اللعبة اضغط ✖ للرجوع هنا، ثم اسحب لأعلى لإغلاق التطبيق.</div>
      <div class="row">
        <button class="btn" id="installBtn">⬇️ أضف للهوم سكرين</button>
      </div>
    </div>

    <!-- شريط علوي + HUD مشترك -->
    <div class="topbar" id="topbar">
      <div class="tabs">
        <button id="tab-space" class="tab">🚀 Space</button>
        <button id="tab-ar" class="tab">🎯 AR</button>
      </div>
      <button id="x" class="xbtn" title="خروج">✖</button>
    </div>
    <div id="hud" class="hud"></div>
    <div id="badges" class="badges"></div>

    <!-- لوحتان -->
    <canvas id="cv-space" width="480" height="720"></canvas>
    <canvas id="cv-ar"    width="480" height="720"></canvas>

    <div class="hint" id="hint">—</div>
  </div>

  <script>
  // تسجيل Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // زر “أضف للهوم سكرين” (تحفيز يدوي على iOS)
  const installBtn = document.getElementById('installBtn');
  installBtn.addEventListener('click', () => {
    alert('من سفاري: المشاركة ▸ أضف للشاشة الرئيسية.\nبعدها شغلها من الأيقونة لفل-سكرين.');
  });

  // عناصر عامة
  const app = document.getElementById('app');
  const landing = document.getElementById('landing');
  const topbar = document.getElementById('topbar');
  const hud = document.getElementById('hud');
  const badgesWrap = document.getElementById('badges');
  const cvSpace = document.getElementById('cv-space');
  const cvAR = document.getElementById('cv-ar');
  const hint = document.getElementById('hint');
  const tabSpace = document.getElementById('tab-space');
  const tabAR = document.getElementById('tab-ar');
  const btnX = document.getElementById('x');

  // منع تحديد/تكبير بالنقر المزدوج
  document.addEventListener('gesturestart', e=>e.preventDefault());
  document.addEventListener('dblclick', e=>e.preventDefault(), {passive:false});

  // حالة
  const S = { active:null, loops:{}, resizing:false };

  // HUD pill factory
  function pill(label, val){ const s=document.createElement('span'); s.className='pill'; s.innerHTML=`${label}<b>${val}</b>`; s.$v=s.querySelector('b'); return s; }

  // فتح لعبة
  document.getElementById('startSpace').onclick = () => switchGame('space', true);
  document.getElementById('startAR').onclick    = () => switchGame('ar', true);
  tabSpace.onclick = () => switchGame('space', false);
  tabAR.onclick    = () => switchGame('ar', false);
  btnX.onclick     = exitToLanding;

  function exitToLanding(){
    // أوقف الحلقات واعرض شاشة البداية
    Object.values(S.loops).forEach(id=> id && clearInterval(id));
    S.loops = {};
    S.active = null;
    topbar.style.display = 'none';
    hud.style.display = 'none';
    badgesWrap.style.display = 'none';
    cvSpace.style.display = 'none';
    cvAR.style.display = 'none';
    landing.style.display = 'flex';
    hint.textContent = 'اسحب للأعلى لإغلاق التطبيق من iOS.';
  }

  function switchGame(which, fromLanding){
    if (S.active === which && !fromLanding) return;

    // واجهة
    landing.style.display = 'none';
    topbar.style.display = 'flex';
    hud.style.display = 'flex';
    badgesWrap.style.display = (which==='space') ? 'flex' : 'none';

    tabSpace.classList.toggle('active', which==='space');
    tabAR.classList.toggle('active', which==='ar');

    // وقف اللعبة الأخرى
    Object.keys(S.loops).forEach(k=>{ if (k!==which && S.loops[k]) { clearInterval(S.loops[k]); S.loops[k]=null; } });

    // تشغيل الحالية
    S.active = which;
    if (which==='space'){
      cvAR.style.display = 'none'; cvSpace.style.display = 'block';
      startSpace();
      hint.textContent = 'حرّك بالسحب داخل اللوحة. إطلاق تلقائي.';
    } else {
      cvSpace.style.display = 'none'; cvAR.style.display = 'block';
      startAR();
      hint.textContent = 'اضغط مطوّلاً للشحن ثم ارفع إصبعك للرمي.';
    }
  }

  // ====== Space Game (تصادم مُصحّح + يكسّر الأعداء) ======
  function startSpace(){
    const cv=cvSpace, ctx=cv.getContext('2d',{alpha:false});
    fitSpace(); window.addEventListener('resize', fitSpace);
    let unit=16;

    function fitSpace(){
      if (S.resizing) return; S.resizing=true;
      const w=Math.min(window.innerWidth, 900), h=Math.min(window.innerHeight, 1400);
      const s=Math.min(w/480, h/720);
      cv.width=Math.max(360, Math.floor(480*s));
      cv.height=Math.max(560, Math.floor(720*s));
      unit=Math.max(10, (cv.width/28)|0);
      setTimeout(()=>S.resizing=false, 50);
    }

    // HUD
    hud.innerHTML=''; badgesWrap.innerHTML='';
    const Hscore=pill('النقاط: ','0'), Hbest=pill('أفضل: ','0'), Hspeed=pill('السرعة: ','1x'), Hlives=pill('القلوب: ','❤❤❤');
    hud.append(Hscore,Hbest,Hspeed,Hlives);

    // حالة
    let frames=0, speedMul=1, best=loadBest(), paused=false, dead=false;
    let player, enemies, bullets, particles, powerups, boss=null, bossBullets=[];
    let lives=3, spawnEvery=70, enemySpeed=1.6, score=0;
    const held={UP:false,DOWN:false,LEFT:false,RIGHT:false};
    const power={ spread:1, fire:false, lightning:0, coffee:0, shield:0, magnet:false, drones:0, pierce:false, freeze:false };

    const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const hearts=n=>'❤'.repeat(Math.max(0,n))+'♡'.repeat(Math.max(0,3-n));
    const loadBest=()=>{ try{return parseInt(localStorage.getItem('ma_space_best')||'0',10)||0}catch{return 0} };
    const saveBest=v=>{ try{localStorage.setItem('ma_space_best',String(v))}catch{} };
    const overlap=(A,B)=> (A.x < B.x + B.w) && (A.x + A.w > B.x) && (A.y < B.y + B.h) && (A.y + A.h > B.y);

    function updateBadges(){
      badgesWrap.innerHTML='';
      const push=(i,t)=>{ const x=document.createElement('span'); x.className='pill'; x.textContent=i+' '+t; badgesWrap.appendChild(x); };
      push('☕', `رش ${power.spread}`);
      if (power.fire) push('🔥','ناري');
      if (power.lightning>0) push('⚡',`سرعة +${power.lightning}`);
      if (power.shield>0) push('🛡️',`درع ×${power.shield}`);
      if (power.magnet) push('🧲','مغناطيس');
      if (power.drones>0) push('🤖',`درون ×${power.drones}`);
      if (power.pierce) push('🗡️','اختراق');
      if (power.freeze) push('❄️','تبطيء أعداء');
    }
    updateBadges();

    function reset(){
      frames=0; speedMul=1; paused=false; dead=false; score=0; lives=3; spawnEvery=70; enemySpeed=1.6;
      Object.assign(power,{spread:1,fire:false,lightning:0,coffee:0,shield:0,magnet:false,drones:0,pierce:false,freeze:false});
      player={x:cv.width/2,y:cv.height-unit*3.5,w:unit*1.8,h:unit*2.2, baseSpeed:3.0, fireTimer:0};
      enemies=[]; bullets=[]; particles=[]; powerups=[]; boss=null; bossBullets=[];
      Hscore.$v.textContent='0'; Hbest.$v.textContent=String(best); Hspeed.$v.textContent='1x'; Hlives.$v.textContent=hearts(lives);
    }
    reset();

    // لمس للتحريك + منع تحديد
    let t0=null;
    cv.addEventListener('touchstart', e=>{ e.preventDefault(); if(!e.touches[0])return; t0={x:e.touches[0].clientX,y:e.touches[0].clientY}; }, {passive:false});
    cv.addEventListener('touchmove', e=>{ e.preventDefault(); if(!t0||!e.touches[0])return; const dx=e.touches[0].clientX-t0.x, dy=e.touches[0].clientY-t0.y; held.LEFT=dx<-12; held.RIGHT=dx>12; held.UP=dy<-12; held.DOWN=dy>12; }, {passive:false});
    cv.addEventListener('touchend',  e=>{ e.preventDefault(); t0=null; held.UP=held.DOWN=held.LEFT=held.RIGHT=false; }, {passive:false});

    // خلفية
    const starsL1=[], starsL2=[], meteors=[];
    function initSpace(){
      starsL1.length=0; starsL2.length=0; meteors.length=0;
      for(let i=0;i<60;i++) starsL1.push({x:Math.random()*cv.width,y:Math.random()*cv.height,s:Math.random()*1.5+0.5});
      for(let i=0;i<30;i++) starsL2.push({x:Math.random()*cv.width,y:Math.random()*cv.height,s:Math.random()*2+1});
    }
    function drawSpace(){
      ctx.fillStyle='#061021'; ctx.fillRect(0,0,cv.width,cv.height);
      ctx.fillStyle='rgba(255,255,255,0.7)';
      starsL1.forEach(st=>{ st.y+=0.15; if(st.y>cv.height) st.y=0, st.x=Math.random()*cv.width; ctx.fillRect(st.x,st.y,st.s,st.s); });
      starsL2.forEach(st=>{ st.y+=0.35; if(st.y>cv.height) st.y=0, st.x=Math.random()*cv.width; ctx.globalAlpha=.6+.4*Math.sin((frames+st.x)*0.02); ctx.fillRect(st.x,st.y,st.s,st.s); ctx.globalAlpha=1; });
      if (Math.random()<0.02) meteors.push({x:Math.random()*cv.width, y:-20, vx:rand(-2,2), vy:3+Math.random()*2, life:120});
      ctx.strokeStyle='rgba(173,216,230,0.8)'; ctx.lineWidth=2;
      meteors.forEach(m=>{ ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-m.vx*4,m.y-m.vy*4); ctx.stroke(); m.x+=m.vx; m.y+=m.vy; m.life--; });
      for (let i=meteors.length-1;i>=0;i--) if (meteors[i].life<=0||meteors[i].y>cv.height+40) meteors.splice(i,1);
    }

    // رسومات
    function drawPlayer(p){
      ctx.save(); ctx.translate(p.x,p.y);
      ctx.fillStyle='#76d7ea'; ctx.beginPath(); ctx.moveTo(0,-p.h/2); ctx.lineTo(-p.w/2,p.h/2); ctx.lineTo(p.w/2,p.h/2); ctx.closePath(); ctx.fill();
      ctx.fillStyle='#2e86c1'; ctx.fillRect(-p.w*0.6,p.h*0.1,p.w*0.35,p.h*0.18); ctx.fillRect(p.w*0.25,p.h*0.1,p.w*0.35,p.h*0.18);
      const flame=6+(power.lightning*2)+(Math.sin(frames/3)*3);
      ctx.fillStyle= power.fire ? '#ffd166' : '#e67e22';
      ctx.beginPath(); ctx.moveTo(-p.w*0.15,p.h/2); ctx.lineTo(0,p.h/2+flame); ctx.lineTo(p.w*0.15,p.h/2); ctx.fill();
      if (power.shield>0 && frames%6<3){ ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.strokeRect(-p.w/2-3,-p.h/2-3,p.w+6,p.h+6); }
      ctx.restore();
      for(let i=0;i<power.drones;i++){ const off=(i===0?-p.w*0.9:p.w*0.9); ctx.fillStyle='#9b59b6'; ctx.fillRect(p.x+off-6,p.y-6,12,12); }
    }
    function drawEnemy(e){
      ctx.save(); ctx.translate(e.x,e.y);
      ctx.fillStyle='#e74c3c'; ctx.fillRect(-e.w/2,-e.h/2,e.w,e.h);
      ctx.fillStyle='#c0392b'; ctx.fillRect(-e.w/4,-e.h/2,e.w/2,e.h*0.3);
      if(e.hit>0){ ctx.globalAlpha=.5; ctx.fillStyle='#fff'; ctx.fillRect(-e.w/2,-e.h/2,e.w,e.h); ctx.globalAlpha=1; e.hit--; }
      ctx.restore();
    }
    function drawBullet(b){
      if (power.fire){ ctx.fillStyle='#ffb347'; ctx.fillRect(b.x-2,b.y-8,4,10); particles.push({x:b.x+(Math.random()*2-1),y:b.y+Math.random()*6,vx:0,vy:.5,s:2,a:.6,c:'#ff8c42'}); }
      else { ctx.fillStyle='#f5f6fa'; ctx.fillRect(b.x-2,b.y-8,4,10); }
    }

    function addEnemy(){ const w=unit*1.6,h=unit*1.6; enemies.push({x:rand(w,cv.width-w),y:-h,w,h,vy:(enemySpeed+(Math.random()*0.8))*(power.freeze?0.6:1),hp:rand(1,2),hit:0}); }
    function explode(x,y,color='#ffd166'){ for(let i=0;i<10;i++) particles.push({x:x+rand(-6,6),y:y+rand(-6,6),vx:rand(-2,2)/2,vy:rand(-2,2)/2,s:rand(2,4),a:1,c:color}); }
    function spawnPower(x,y){
      const types=['coffee','lightning','fire','shield','magnet','drone','pierce','freeze'];
      const weights=[22,18,14,12,10,10,8,6];
      let r=Math.random()*weights.reduce((a,b)=>a+b,0);
      for(let i=0;i<types.length;i++){ r-=weights[i]; if(r<=0){ powerups.push({type:types[i],x,y,vy:1.2}); break; } }
    }
    function applyPower(t){
      if (t==='coffee'){ power.coffee++; power.spread=Math.min(9, power.spread+2); }
      else if (t==='lightning'){ power.lightning++; }
      else if (t==='fire'){ power.fire=true; }
      else if (t==='shield'){ power.shield=Math.min(9, power.shield+1); }
      else if (t==='magnet'){ power.magnet=true; }
      else if (t==='drone'){ power.drones=Math.min(2, power.drones+1); }
      else if (t==='pierce'){ power.pierce=true; }
      else if (t==='freeze'){ power.freeze=true; }
      updateBadges();
    }

    function shoot(){
      const baseDelay=11; if (player.fireTimer>0) return;
      const rateBonus=Math.min(6, power.coffee+power.lightning);
      player.fireTimer=Math.max(3, baseDelay-rateBonus);
      const count=power.spread, angleStep=0.10, mid=(count-1)/2, y=player.y - player.h/2 - 4;
      for(let i=0;i<count;i++){ const a=(i-mid)*angleStep; bullets.push({x:player.x, y, vx:Math.sin(a)*2, vy:-7, pierce: power.pierce? 2:0}); }
      if (power.drones>0) bullets.push({x:player.x-player.w*0.9, y, vx:-0.5, vy:-7.2, pierce: power.pierce? 1:0});
      if (power.drones>1) bullets.push({x:player.x+player.w*0.9, y, vx: 0.5, vy:-7.2, pierce: power.pierce? 1:0});
    }

    function spawnBoss(){
      const w=Math.max(unit*6, Math.floor(cv.width*0.35)), h=Math.max(unit*4, Math.floor(cv.height*0.12));
      const level=Math.floor(score/30);
      boss={x:cv.width/2,y:h/2+20,w,h,vx:2+level*0.2,dir:1,hp:40+level*18,maxHp:40+level*18,fireCd:0,pattern:0};
      bossBullets=[];
    }
    function drawBoss(b){
      ctx.save(); ctx.translate(b.x,b.y); ctx.fillStyle='#8e44ad'; ctx.fillRect(-b.w/2,-b.h/2,b.w,b.h);
      ctx.fillStyle='#7d3c98'; ctx.fillRect(-b.w*0.3,-b.h/2,b.w*0.6,b.h*0.25); ctx.restore();
      const barW=Math.min(cv.width*0.8,b.w), barH=10, x=(cv.width-barW)/2, y=12;
      ctx.fillStyle='#1b2b44'; ctx.fillRect(x,y,barW,barH); ctx.fillStyle='#e74c3c'; ctx.fillRect(x,y,barW*(b.hp/b.maxHp),barH); ctx.strokeStyle='#000'; ctx.strokeRect(x,y,barW,barH);
    }

    function step(){
      frames++;

      if (!boss && frames%220===0){ spawnEvery=Math.max(34, spawnEvery-4); enemySpeed=Math.min(3.5, enemySpeed+0.15); }

      const sp = player.baseSpeed * (1 + 0.18*power.lightning);
      player.x = clamp(player.x + ((held.LEFT?-sp:0)+(held.RIGHT?sp:0)), player.w/2, cv.width-player.w/2);
      player.y = clamp(player.y + ((held.UP?-sp:0)+(held.DOWN?sp:0)),   player.h/2, cv.height-player.h/2);

      shoot(); if (player.fireTimer>0) player.fireTimer--;

      if (!boss && frames % Math.max(18, Math.floor(spawnEvery))===0) addEnemy();

      if (!boss && score>0 && score % 30===0){ enemies.length=0; spawnBoss(); }

      bullets.forEach(b=>{ b.y+=b.vy; b.x+=(b.vx||0); });
      for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; if (b.y<-30||b.x<-30||b.x>cv.width+30) bullets.splice(i,1); }

      enemies.forEach(e=>{ e.y += e.vy * (power.freeze?0.6:1); });
      for(let i=enemies.length-1;i>=0;i--) if (enemies[i].y>cv.height+enemies[i].h+10) enemies.splice(i,1);

      // تصادم (مُصلّح) — يكسر المربعات
      outer: for (let i=0;i<bullets.length;i++){
        const b=bullets[i];
        for (let j=0;j<enemies.length;j++){
          const e=enemies[j];
          if (overlap({x:b.x-2,y:b.y-8,w:4,h:10},{x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
            e.hp -= power.fire?2:1; e.hit=4;
            if (b.pierce>0){ b.pierce--; } else { bullets.splice(i,1); i--; }
            if (e.hp<=0){
              explode(e.x,e.y); if (Math.random()<0.45) spawnPower(e.x,e.y);
              enemies.splice(j,1); j--;
              score++; if (score>best){ best=score; saveBest(best); }
              Hscore.$v.textContent=String(score); Hbest.$v.textContent=String(best);
            }
            continue outer;
          }
        }
      }

      powerups.forEach(pu=>{
        pu.y += 1.2;
        if (power.magnet){ const dx=player.x-pu.x, dy=player.y-pu.y, d=Math.hypot(dx,dy); if (d<180){ pu.x+=dx*0.05; pu.y+=dy*0.05; } }
      });
      for (let i=powerups.length-1;i>=0;i--){
        const pu=powerups[i];
        if (overlap({x:pu.x-10,y:pu.y-10,w:20,h:20},{x:player.x-player.w/2,y:player.y-player.h/2,w:player.w,h:player.h})){ applyPower(pu.type); powerups.splice(i,1); }
        else if (pu.y>cv.height+30) powerups.splice(i,1);
      }

      if (boss){
        boss.x += boss.vx*boss.dir;
        if (boss.x-boss.w/2<8 || boss.x+boss.w/2>cv.width-8) boss.dir*=-1;
        if (boss.fireCd>0) boss.fireCd--;
        else {
          boss.pattern = (boss.pattern+1)%3;
          if (boss.pattern===0){ for(let i=-2;i<=2;i++) bossBullets.push({x:boss.x+i*20,y:boss.y+boss.h/2,vx:i*0.5,vy:3}); }
          else if (boss.pattern===1){ for(let a=-3;a<=3;a++) bossBullets.push({x:boss.x,y:boss.y+boss.h/2,vx:a*0.35,vy:2.6}); }
          else { for(let i=0;i<6;i++) bossBullets.push({x:rand(boss.x-boss.w/2+20,boss.x+boss.w/2-20),y:boss.y+boss.h/2,vx:0,vy:3.5}); }
          boss.fireCd = Math.max(22, 46 - Math.floor(score/10));
        }
        bossBullets.forEach(bb=>{ bb.x+=bb.vx; bb.y+=bb.vy; });
        for(let i=bossBullets.length-1;i>=0;i--){ const bb=bossBullets[i]; if (bb.y>cv.height+30||bb.x<-30||bb.x>cv.width+30) bossBullets.splice(i,1); }

        // رصاص اللاعب × البوس
        for (let i=0;i<bullets.length;i++){
          const b=bullets[i];
          if (overlap({x:b.x-2,y:b.y-8,w:4,h:10},{x:boss.x-boss.w/2,y:boss.y-boss.h/2,w:boss.w,h:boss.h})){
            boss.hp -= power.fire?2:1; if (b.pierce>0){ b.pierce--; } else { bullets.splice(i,1); i--; }
            if (boss.hp<=0){
              explode(boss.x,boss.y);
              for(let k=0;k<4;k++) spawnPower(boss.x+rand(-40,40), boss.y+rand(-10,10));
              boss=null; bossBullets.length=0; score+=5; if(score>best){ best=score; saveBest(best); }
              Hscore.$v.textContent=String(score); Hbest.$v.textContent=String(best);
              break;
            }
          }
        }

        // لاعب × رصاص البوس
        for (let i=bossBullets.length-1;i>=0;i--){
          const bb=bossBullets[i];
          if (overlap({x:player.x-player.w/2,y:player.y-player.h/2,w:player.w,h:player.h},{x:bb.x-3,y:bb.y-6,w:6,h:12})){
            bossBullets.splice(i,1);
            if (power.shield>0){ power.shield--; updateBadges(); }
            else { lives--; Hlives.$v.textContent=hearts(lives); if (lives<=0){ dead=true; } }
          }
        }
      }

      // رسم
      drawSpace();
      enemies.forEach(drawEnemy);
      bullets.forEach(drawBullet);
      // أيقونات الباور
      powerups.forEach(pu=>{
        ctx.save(); ctx.translate(pu.x,pu.y);
        const t=pu.type; ctx.fillStyle='#fff';
        if(t==='coffee'){ ctx.fillStyle='#f1c40f'; ctx.fillRect(-8,-10,16,10); ctx.fillStyle='#6e2c00'; ctx.fillRect(-6,-8,12,6); }
        else if(t==='lightning'){ ctx.fillStyle='#f9e79f'; ctx.beginPath(); ctx.moveTo(-4,-10); ctx.lineTo(2,-10); ctx.lineTo(-1,0); ctx.lineTo(4,0); ctx.lineTo(-2,10); ctx.lineTo(0,2); ctx.closePath(); ctx.fill(); }
        else if(t==='fire'){ ctx.fillStyle='#ff6b6b'; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#ffa502'; ctx.beginPath(); ctx.arc(0,2,5,0,Math.PI*2); ctx.fill(); }
        else if(t==='shield'){ ctx.fillStyle='#5dade2'; ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(8,-4); ctx.lineTo(6,8); ctx.lineTo(-6,8); ctx.lineTo(-8,-4); ctx.closePath(); ctx.fill(); }
        else if(t==='magnet'){ ctx.fillStyle='#e74c3c'; ctx.fillRect(-8,-8,6,16); ctx.fillStyle='#c0392b'; ctx.fillRect(2,-8,6,16); }
        else if(t==='drone'){ ctx.fillStyle='#9b59b6'; ctx.fillRect(-8,-6,16,12); }
        else if(t==='pierce'){ ctx.fillStyle='#ecf0f1'; ctx.fillRect(-2,-10,4,20); }
        else if(t==='freeze'){ ctx.fillStyle='#a3d5ff'; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill(); }
        ctx.restore();
      });

      Hspeed.$v.textContent = speedMul.toFixed(1)+'x';

      // سباون
      if (frames===0) initSpace();
      if (!boss && frames % Math.max(18, Math.floor(spawnEvery))===0) addEnemy();
    }

    S.loops.space && clearInterval(S.loops.space);
    S.loops.space = setInterval(startSpace, 1000/60); // أول تشغيل
  }

  // ====== AR Game (إصلاح اللمس + شحن/رمي) ======
  function startAR(){
    const cv=cvAR, ctx=cv.getContext('2d',{alpha:false});
    fitAR(); window.addEventListener('resize', fitAR);
    function fitAR(){
      const w=Math.min(window.innerWidth, 900), h=Math.min(window.innerHeight, 1400);
      const s=Math.min(w/480, h/720);
      cv.width=Math.max(360, Math.floor(480*s));
      cv.height=Math.max(560, Math.floor(720*s));
      W=cv.width; H=cv.height;
      groundY=Math.floor(H*0.84); pxMeter=H/14; player.x=Math.floor(W*0.16); player.y=groundY-player.r; redrawStatic=true;
    }
    let W=cv.width,H=cv.height, groundY=Math.floor(H*0.84), pxMeter=H/14;
    const g = 9.8*(pxMeter/60/60)*60;
    const player={x:Math.floor(W*0.16), y:groundY-12, r:12, charging:false, chargeT:0, maxV:1100};
    let score=0, stage=1, target={x:0,r:20}, shot=null, trail=[], redrawStatic=true;

    hud.innerHTML='';
    const Hscore=pill('النقاط: ','0'), Hstage=pill('مرحلة: ','1'), Hdist=pill('مسافة: ','—');
    hud.append(Hscore,Hstage,Hdist); badgesWrap.style.display='none';

    const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const deg2rad=d=>d*Math.PI/180, lerp=(a,b,t)=>a+(b-a)*t, easeOutCubic=t=>1-Math.pow(1-t,3);
    const aim={ angle:deg2rad(45), vec:{x:Math.cos(deg2rad(45)), y:Math.sin(deg2rad(45))} };

    function updHUD(){
      Hscore.$v.textContent=String(score);
      Hstage.$v.textContent=String(stage);
      Hdist.$v.textContent = Math.max(1, Math.round((target.x-player.x)/pxMeter))+' m';
    }
    function placeTarget(){
      const minX=Math.floor(W*0.45);
      const maxX=Math.min(W-40, Math.floor(W*(0.55+Math.min(0.35,(stage-1)*0.06))));
      target.x = rand(minX, Math.max(minX+40,maxX)); updHUD(); redrawStatic=true;
    }

    // لمس/ماوس — كلّها داخل اللوحة + منع السحب
    cv.addEventListener('touchstart', e=>{ e.preventDefault(); startCharge(e.touches[0]); }, {passive:false});
    cv.addEventListener('touchmove',  e=>{ e.preventDefault(); updateAim(e.touches[0]); }, {passive:false});
    cv.addEventListener('touchend',   e=>{ e.preventDefault(); release(); }, {passive:false});
    cv.addEventListener('mousedown',  e=> startCharge(e));
    cv.addEventListener('mousemove',  e=> updateAim(e));
    window.addEventListener('mouseup',()=> release());

    function cpos(evt){ const r=cv.getBoundingClientRect(); return {x:(evt.clientX-r.left), y:(evt.clientY-r.top)}; }
    function startCharge(evt){ player.charging=true; player.chargeT=0; updateAim(evt); }
    function updateAim(evt){
      if (!player.charging) return;
      const p=cpos(evt); const dx=p.x-player.x, dy=player.y-p.y; let a=Math.atan2(dy,dx);
      a = clamp(a, deg2rad(15), deg2rad(75)); aim.angle=a; aim.vec={x:Math.cos(a), y:Math.sin(a)};
    }
    function release(){
      if (!player.charging) return; player.charging=false;
      const t = Math.min(1, player.chargeT/900), v0 = lerp(380, player.maxV, easeOutCubic(t));
      shot = { x:player.x, y:player.y, vx: aim.vec.x*v0, vy: -aim.vec.y*v0, live:true }; trail=[];
    }

    function drawGround(){
      const grad=ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0,'#0a274d'); grad.addColorStop(1,'#07121f'); ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#061427'; ctx.fillRect(0,groundY,W,H-groundY);
      ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1;
      for(let i=0;i<14;i++){ const y=groundY+(H-groundY)*(i/13); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
      const vpX=Math.floor(W*0.5), vpY=Math.floor(H*0.52);
      for(let i=0;i<=14;i++){ const x=i/14*W; ctx.beginPath(); ctx.moveTo(x,H); ctx.lineTo(vpX,vpY); ctx.stroke(); }
    }
    function drawTarget(){
      ctx.save(); ctx.translate(target.x, groundY);
      ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.beginPath(); ctx.ellipse(0,4,target.r*1.4,target.r*0.5,0,0,Math.PI*2); ctx.fill();
      ctx.lineWidth=4; ctx.strokeStyle='#f59e0b'; ctx.beginPath(); ctx.arc(0,0,target.r,0,Math.PI*2); ctx.stroke();
      ctx.strokeStyle='#fef08a'; ctx.beginPath(); ctx.arc(0,0,target.r*0.55,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }
    function drawPlayer(){
      ctx.fillStyle='#8ed1fc'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
      const w=110,h=10,x=player.x-55,y=player.y+player.r+12;
      ctx.fillStyle='rgba(255,255,255,0.15)'; ctx.fillRect(x,y,w,h);
      const pct = player.charging ? Math.min(1, player.chargeT/900) : 0;
      ctx.fillStyle='#22c55e'; ctx.fillRect(x,y,Math.floor(w*pct),h);
      ctx.strokeStyle='rgba(255,255,255,0.25)'; ctx.strokeRect(x,y,w,h);
    }
    function drawAim(){
      if (!player.charging) return;
      const d=aim.vec; ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(player.x,player.y); ctx.lineTo(player.x+d.x*80, player.y-d.y*80); ctx.stroke();
      // مسار تقديري
      const samples=18, v0= (380 + (1100-380)* (1-Math.pow(1-Math.min(1,player.chargeT/900),3)));
      const vx=d.x*v0/60, vy0=-d.y*v0/60; let x=player.x, y=player.y, vy=vy0; ctx.fillStyle='rgba(255,255,255,0.4)';
      for(let i=0;i<samples;i++){ x+=vx*2.5; vy += (g/60)*2.5; y+=vy*2.5; if (y>groundY) break; ctx.beginPath(); ctx.arc(x,y,2.2,0,Math.PI*2); ctx.fill(); }
    }
    function drawShot(){
      if(!shot) return;
      ctx.strokeStyle='rgba(255,255,255,0.25)'; ctx.lineWidth=2; ctx.beginPath();
      trail.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y)); ctx.stroke();
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(shot.x,shot.y,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.beginPath(); ctx.ellipse(Math.max(0,Math.min(W,shot.x)), groundY+3, 10,4,0,0,Math.PI*2); ctx.fill();
    }

    function physics(){
      if (S.active!=='ar') return;
      if (player.charging) player.chargeT += 1000/60;
      if (shot && shot.live){
        shot.x += shot.vx/60; shot.vy += g/60; shot.y += shot.vy/60;
        trail.push({x:shot.x,y:shot.y}); if (trail.length>30) trail.shift();
        if (shot.y >= groundY){
          if (Math.abs(shot.x - target.x) <= target.r){ score++; if (score%4===0) stage++; placeTarget(); }
          shot.live=false; setTimeout(()=>{ shot=null; trail=[]; }, 160);
          updHUD();
        }
      }
    }
    function draw(){
      if (S.active!=='ar') return;
      if (redrawStatic){ drawGround(); redrawStatic=false; } else { ctx.fillStyle='rgba(3,16,36,0.25)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#061427'; ctx.fillRect(0,groundY,W,H-groundY); }
      drawTarget(); drawAim(); drawPlayer(); drawShot();
    }

    placeTarget(); updHUD();
    S.loops.ar && clearInterval(S.loops.ar);
    S.loops.ar = setInterval(()=>{ physics(); draw(); }, 1000/60);
  }
  </script>
</body>
</html>
